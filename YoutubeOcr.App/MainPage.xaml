<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ui="clr-namespace:YoutubeOcr.App.UI"
             x:Class="YoutubeOcr.App.MainPage"
             Title="YouTube OCR"
             BackgroundColor="{StaticResource AppBackground}">
    <Grid Padding="{StaticResource OuterPadding}" RowSpacing="0" ColumnSpacing="16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="240" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Left navigation -->
        <Border Grid.Column="0"
                Style="{StaticResource CardStyle}"
                Padding="18">
            <VerticalStackLayout Spacing="16">
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                    <ui:PixelStarView WidthRequest="26" HeightRequest="26" />
                    <VerticalStackLayout Spacing="2" Grid.Column="1">
                        <Label Text="Pixel Tool" Style="{StaticResource BadgeLabelStyle}" />
                        <Label Text="YouTube OCR Pixel Studio" Style="{StaticResource TitleLabelStyle}" />
                    </VerticalStackLayout>
                </Grid>

                <Border Style="{StaticResource MutedCardStyle}">
                    <VerticalStackLayout Spacing="6">
                        <Label Text="流程步骤" Style="{StaticResource CardTitleLabelStyle}" />
                        <Label Text="Download -> Frames -> OCR -> Settings" Style="{StaticResource HintLabelStyle}" />
                    </VerticalStackLayout>
                </Border>

                <VerticalStackLayout Spacing="8">
                    <Button x:Name="NavDownloadButton" Text="Step 1 · 下载" Style="{StaticResource NavButtonStyle}" Clicked="OnNavButtonClicked" />
                    <Button x:Name="NavFramesButton" Text="Step 2 · 抽帧" Style="{StaticResource NavButtonStyle}" Clicked="OnNavButtonClicked" />
                    <Button x:Name="NavOcrButton" Text="Step 3 · OCR" Style="{StaticResource NavButtonStyle}" Clicked="OnNavButtonClicked" />
                    <Button x:Name="NavMoreButton" Text="Step 4 · 设置" Style="{StaticResource NavButtonStyle}" Clicked="OnNavButtonClicked" />
                </VerticalStackLayout>

                <Border Style="{StaticResource TagPinkStyle}">
                    <Label Text="保持像素风与流程稳定" Style="{StaticResource BadgeLabelStyle}" />
                </Border>
                <ui:PixelCatBlackView HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Border>

        <!-- Main surface -->
        <Grid Grid.Column="1" RowSpacing="14">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" Style="{StaticResource MutedCardStyle}">
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="16" VerticalOptions="Center">
                    <VerticalStackLayout Spacing="6">
                        <Label x:Name="StepTitleLabel" Text="Step 1 · 下载" Style="{StaticResource SectionTitleLabelStyle}" />
                        <Label x:Name="StepSubtitleLabel" Text="“知识在流动的路径上重生。”" Style="{StaticResource HintLabelStyle}" />
                        <HorizontalStackLayout Spacing="8">
                            <Border Style="{StaticResource PillBadgeStyle}">
                                <Label Text="下载队列" Style="{StaticResource BadgeLabelStyle}" />
                            </Border>
                            <Border Style="{StaticResource PillBadgeStyle}">
                                <Label Text="抽帧" Style="{StaticResource BadgeLabelStyle}" />
                            </Border>
                            <Border Style="{StaticResource TagPinkStyle}">
                                <Label Text="OCR" Style="{StaticResource BadgeLabelStyle}" />
                            </Border>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                    <StackLayout Grid.Column="1" Spacing="6" HorizontalOptions="End" VerticalOptions="Center">
                        <ui:PixelDoodleBubble WidthRequest="140" HeightRequest="96" />
                        <ui:PixelCatCalicoView WidthRequest="64" HeightRequest="64" HorizontalOptions="End" />
                    </StackLayout>
                </Grid>
            </Border>

            <!-- Content host -->
            <Grid Grid.Row="1">
                <ScrollView>
                    <VerticalStackLayout Spacing="14">
                        <!-- Download -->
                        <Grid x:Name="DownloadContent" RowSpacing="14" ColumnSpacing="14">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="单链接添加" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Label Text="输入单个 YouTube 链接，加入队列后再开始下载。" Style="{StaticResource HintLabelStyle}" />
                                    <Border Style="{StaticResource FieldWrapperStyle}">
                                        <Entry x:Name="UrlEntry" Placeholder="https://www.youtube.com/watch?v=..." />
                                    </Border>
                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="添加到队列" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnAddUrlClicked" />
                                        <Button Text="清空输入" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnClearUrlClicked" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="批量导入" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Label Text="每行一条链接，可一次粘贴多个。" Style="{StaticResource HintLabelStyle}" />
                                    <Border Style="{StaticResource FieldWrapperStyle}">
                                        <Editor x:Name="BatchUrlsEditor" Placeholder="在此粘贴多条链接..." AutoSize="TextChanges" HeightRequest="110" />
                                    </Border>
                                    <Button Text="导入到队列" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnImportUrlsClicked" />
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="下载队列" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <CollectionView x:Name="DownloadListView" HeightRequest="200" SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource FieldWrapperStyle}" Margin="0,4">
                                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="4">
                                                        <Label Grid.Row="0" Grid.Column="0" Text="{Binding Url}" LineBreakMode="TailTruncation" />
                                                        <Label Grid.Row="1" Grid.Column="0" Text="{Binding Status}" Style="{StaticResource HintLabelStyle}" />
                                                        <Button Grid.RowSpan="2" Grid.Column="1" Text="移除" Style="{StaticResource GhostButtonStyle}" Padding="10,6" WidthRequest="70" CommandParameter="{Binding .}" Clicked="OnRemoveUrlClicked" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="清空队列" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnClearQueueClicked" />
                                        <Button Text="填充示例链接" Style="{StaticResource GhostButtonStyle}" Clicked="OnFillSampleClicked" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Label Text="输出目录" Style="{StaticResource CardTitleLabelStyle}" />
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Label Text="点击浏览可选择下载落地路径。" Style="{StaticResource HintLabelStyle}" />
                                    <Border Style="{StaticResource FieldWrapperStyle}">
                                        <Entry x:Name="DownloadOutputEntry" IsReadOnly="True" />
                                    </Border>
                                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                                        <Button Text="浏览..." Style="{StaticResource SecondaryButtonStyle}" Clicked="OnBrowseDownloadFolderClicked" />
                                        <Switch x:Name="AutoUpdateSwitch" IsToggled="True" VerticalOptions="Center" />
                                        <Label Text="启用 yt-dlp 更新检测" Style="{StaticResource HintLabelStyle}" VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                    <VerticalStackLayout Spacing="6">
                                        <ProgressBar x:Name="DownloadProgressBar" Progress="0" HeightRequest="8" />
                                        <Label x:Name="DownloadProgressLabel" Text="等待开始" Style="{StaticResource HintLabelStyle}" />
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="2" Grid.ColumnSpan="2" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="下载执行" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <HorizontalStackLayout Spacing="12">
                                        <Button Text="开始下载" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnDownloadClicked" />
                                        <Button Text="取消选择" Style="{StaticResource GhostButtonStyle}" Clicked="OnClearSelectionClicked" />
                                    </HorizontalStackLayout>
                                    <Label Text="下载完成的视频会自动出现在抽帧下拉列表中。" Style="{StaticResource HintLabelStyle}" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <!-- Frame extraction -->
                        <Grid x:Name="FrameContent" RowSpacing="14" ColumnSpacing="14" IsVisible="False">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="选择视频" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Label Text="选择下载结果或手动指定本地视频路径。" Style="{StaticResource HintLabelStyle}" />
                                    <Picker x:Name="VideoPicker" Title="选择已下载视频" />
                                    <Border Style="{StaticResource FieldWrapperStyle}">
                                        <Entry x:Name="VideoPathEntry" Placeholder="C:\videos\sample.mp4" />
                                    </Border>
                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="刷新下载列表" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnSyncDownloadsClicked" />
                                        <Button Text="浏览视频..." Style="{StaticResource GhostButtonStyle}" Clicked="OnBrowseVideoClicked" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Label Text="帧输出目录" Style="{StaticResource CardTitleLabelStyle}" />
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Label Text="抽帧输出的根目录，可自定义。" Style="{StaticResource HintLabelStyle}" />
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10" VerticalOptions="Center">
                                        <Border Grid.Column="0" Style="{StaticResource FieldWrapperStyle}">
                                            <Entry x:Name="FrameOutputEntry" IsReadOnly="True" />
                                        </Border>
                                        <Button Grid.Column="1" Text="浏览..." Style="{StaticResource SecondaryButtonStyle}" Clicked="OnBrowseFramesFolderClicked" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="抽帧参数" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                        <Label Grid.Row="0" Grid.Column="0" Text="目标 FPS" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                        <Entry Grid.Row="0" Grid.Column="1" x:Name="TargetFpsEntry" Text="1.0" Keyboard="Numeric" />

                                        <Label Grid.Row="1" Grid.Column="0" Text="开始时间 hh:mm:ss" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                        <Entry Grid.Row="1" Grid.Column="1" x:Name="StartTimeEntry" Placeholder="00:00:00" />

                                        <Label Grid.Row="2" Grid.Column="0" Text="结束时间 hh:mm:ss" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                        <Entry Grid.Row="2" Grid.Column="1" x:Name="EndTimeEntry" Placeholder="00:00:10" />

                                        <Label Grid.Row="3" Grid.Column="0" Text="格式 / 尺寸" HorizontalTextAlignment="End" VerticalOptions="Center" />
                                        <HorizontalStackLayout Grid.Row="3" Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                            <Entry x:Name="OutputFormatEntry" WidthRequest="80" Text="jpg" />
                                            <Entry x:Name="ResizeWidthEntry" WidthRequest="70" Placeholder="W" Keyboard="Numeric" />
                                            <Entry x:Name="ResizeHeightEntry" WidthRequest="70" Placeholder="H" Keyboard="Numeric" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="预览 / ROI" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Border Style="{StaticResource FieldWrapperStyle}" HeightRequest="220" BackgroundColor="{StaticResource SoftLilac}">
                                        <Grid>
                                            <Image x:Name="PreviewImage" Aspect="AspectFit" />
                                            <Border x:Name="RoiOverlay"
                                                    BackgroundColor="#40FFFFFF"
                                                    Stroke="{StaticResource HighlightIndigo}"
                                                    StrokeThickness="1"
                                                    IsVisible="False"
                                                    HorizontalOptions="Start"
                                                    VerticalOptions="Start" />
                                        </Grid>
                                    </Border>
                                    <Grid RowDefinitions="Auto,Auto"
                                          ColumnDefinitions="Auto,*,Auto,*"
                                          ColumnSpacing="8"
                                          RowSpacing="6">
                                        <Label Grid.Row="0" Grid.Column="0" Text="X" VerticalOptions="Center" />
                                        <Entry Grid.Row="0" Grid.Column="1" x:Name="RoiXEntry" Keyboard="Numeric" />

                                        <Label Grid.Row="0" Grid.Column="2" Text="Y" VerticalOptions="Center" />
                                        <Entry Grid.Row="0" Grid.Column="3" x:Name="RoiYEntry" Keyboard="Numeric" />

                                        <Label Grid.Row="1" Grid.Column="0" Text="W" VerticalOptions="Center" />
                                        <Entry Grid.Row="1" Grid.Column="1" x:Name="RoiWidthEntry" Keyboard="Numeric" />

                                        <Label Grid.Row="1" Grid.Column="2" Text="H" VerticalOptions="Center" />
                                        <Entry Grid.Row="1" Grid.Column="3" x:Name="RoiHeightEntry" Keyboard="Numeric" />
                                    </Grid>
                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="应用 ROI" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnApplyRoiClicked" />
                                        <Button Text="抓取预览帧" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnPreviewFrameClicked" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="2" Grid.ColumnSpan="2" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="抽帧执行" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <HorizontalStackLayout Spacing="12">
                                        <Button Text="开始抽帧" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnExtractClicked" />
                                        <Button Text="使用下载结果" Style="{StaticResource GhostButtonStyle}" Clicked="OnSyncDownloadsClicked" />
                                    </HorizontalStackLayout>
                                    <VerticalStackLayout Spacing="6">
                                        <ProgressBar x:Name="FrameProgressBar" Progress="0" HeightRequest="8" />
                                        <Label x:Name="FrameProgressLabel" Text="等待开始" Style="{StaticResource HintLabelStyle}" />
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <!-- OCR -->
                        <Grid x:Name="OcrContent" RowSpacing="14" ColumnSpacing="14" IsVisible="False">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="帧目录" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*" RowSpacing="8" ColumnSpacing="10">
                                        <Label Grid.Row="0" Grid.Column="0" Text="帧目录" HorizontalOptions="End" VerticalOptions="Center" />
                                        <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="6">
                                            <Entry x:Name="FrameDirEntry" Placeholder="C:\frames\video1" HorizontalOptions="FillAndExpand" />
                                            <Button Text="浏览" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnBrowseFrameDirClicked" />
                                            <Button Text="最近" Style="{StaticResource GhostButtonStyle}" Clicked="OnUseLastFramesClicked" />
                                        </HorizontalStackLayout>

                                        <Label Grid.Row="1" Grid.Column="0" Text="语言" HorizontalOptions="End" VerticalOptions="Center" />
                                        <Picker Grid.Row="1" Grid.Column="1" x:Name="OcrLanguagePicker">
                                            <Picker.Items>
                                                <x:String>zh-CN</x:String>
                                                <x:String>en-US</x:String>
                                                <x:String>ja-JP</x:String>
                                                <x:String>ko-KR</x:String>
                                                <x:String>zh-TW</x:String>
                                            </Picker.Items>
                                        </Picker>

                                        <Label Grid.Row="2" Grid.Column="0" Text="置信度" HorizontalOptions="End" VerticalOptions="Center" />
                                        <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="8" VerticalOptions="Center">
                                            <Slider x:Name="OcrConfidenceSlider" Minimum="0" Maximum="1" Value="0.5" WidthRequest="180" ValueChanged="OnOcrConfidenceChanged" />
                                            <Label x:Name="OcrConfidenceValueLabel" Text="0.50" VerticalOptions="Center" />
                                        </HorizontalStackLayout>

                                        <Label Grid.Row="3" Grid.Column="0" Text="去重" HorizontalOptions="End" VerticalOptions="Center" />
                                        <HorizontalStackLayout Grid.Row="3" Grid.Column="1" Spacing="6" VerticalOptions="Center">
                                            <Switch x:Name="DedupSwitch" IsToggled="True" />
                                            <Entry x:Name="DedupWindowEntry" WidthRequest="100" Text="1.0" Keyboard="Numeric" Placeholder="窗口(s)" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="OCR 执行" Style="{StaticResource CardTitleLabelStyle}" />
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="开始 OCR" Style="{StaticResource PrimaryActionButtonStyle}" Clicked="OnOcrClicked" />
                                        <Button Text="刷新目录" Style="{StaticResource GhostButtonStyle}" Clicked="OnUseLastFramesClicked" />
                                    </HorizontalStackLayout>
                                    <VerticalStackLayout Spacing="6">
                                        <ProgressBar x:Name="OcrProgressBar" Progress="0" HeightRequest="8" />
                                        <Label x:Name="OcrProgressLabel" Text="等待开始" Style="{StaticResource HintLabelStyle}" />
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="结果列表" Style="{StaticResource CardTitleLabelStyle}" />
                                    <CollectionView x:Name="OcrResultsView" HeightRequest="220" SelectionMode="Single" SelectionChanged="OnOcrResultSelected">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource FieldWrapperStyle}" Margin="0,4">
                                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                                        <VerticalStackLayout Spacing="2">
                                                            <Label Text="{Binding VideoId}" FontAttributes="Bold" />
                                                            <Label Text="{Binding Timestamp}" Style="{StaticResource HintLabelStyle}" />
                                                            <Label Text="{Binding Text}" LineBreakMode="TailTruncation" />
                                                        </VerticalStackLayout>
                                                        <Label Text="{Binding Confidence, StringFormat='{}{0:F2}'}" VerticalOptions="Center" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="帧预览" Style="{StaticResource CardTitleLabelStyle}" />
                                    <Label Text="选择结果行时，显示对应帧。" Style="{StaticResource HintLabelStyle}" />
                                    <Border Style="{StaticResource FieldWrapperStyle}" HeightRequest="200" BackgroundColor="{StaticResource SoftLilac}">
                                        <Image x:Name="OcrPreviewImage" Aspect="AspectFit" />
                                    </Border>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <!-- More / settings -->
                        <Grid x:Name="MoreContent" RowSpacing="14" ColumnSpacing="14" IsVisible="False">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Border Grid.ColumnSpan="2" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="10">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                                        <Label Text="更多 / 设置" Style="{StaticResource CardTitleLabelStyle}" />
                                    </Grid>
                                    <BoxView HeightRequest="1" BackgroundColor="{StaticResource BorderColor}" />
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                        <Label Text="应用版本" />
                                        <Label x:Name="AppVersionLabel" />
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                        <Label Text="配置文件" />
                                        <Label x:Name="ConfigPathLabel" LineBreakMode="TailTruncation" />
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                        <Label Text="工具目录" />
                                        <Label x:Name="ToolsPathLabel" LineBreakMode="TailTruncation" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Column="0" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="下载选项" Style="{StaticResource CardTitleLabelStyle}" />
                                    <HorizontalStackLayout Spacing="10">
                                        <Switch x:Name="AutoUpdateYtDlpSwitch" IsToggled="True" />
                                        <Label Text="启动时检查 yt-dlp 更新" Style="{StaticResource HintLabelStyle}" VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                    <HorizontalStackLayout Spacing="10">
                                        <Switch x:Name="VideoOnlySwitch" IsToggled="True" />
                                        <Label Text="仅下载视频轨" Style="{StaticResource HintLabelStyle}" VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Column="1" Style="{StaticResource CardStyle}" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="日志与导出" Style="{StaticResource CardTitleLabelStyle}" />
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="日志目录" VerticalOptions="Center" />
                                        <Label x:Name="LogPathLabel" Style="{StaticResource HintLabelStyle}" LineBreakMode="TailTruncation" />
                                    </HorizontalStackLayout>
                                    <Button Text="打开日志目录" Style="{StaticResource SecondaryButtonStyle}" Clicked="OnOpenLogFolderClicked" />
                                    <Border Style="{StaticResource PillBadgeStyle}">
                                        <Label Text="导出格式：CSV / TXT" Style="{StaticResource BadgeLabelStyle}" />
                                    </Border>
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                </ScrollView>
                <Grid InputTransparent="True">
                    <ui:PixelCatTabbyView HorizontalOptions="End" VerticalOptions="End" Margin="0,0,6,6" />
                </Grid>
            </Grid>

            <!-- Logs -->
            <Border Grid.Row="2" Style="{StaticResource CardStyle}">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" VerticalOptions="Center">
                        <ui:PixelStarView WidthRequest="18" HeightRequest="18" />
                        <Label Text="日志" Style="{StaticResource CardTitleLabelStyle}" />
                    </Grid>
                    <Border Style="{StaticResource FieldWrapperStyle}" StrokeThickness="1">
                        <CollectionView x:Name="LogCollectionView"
                                        ItemsSource="{Binding LogMessages}"
                                        HeightRequest="200"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Label Text="{Binding .}"
                                           Style="{StaticResource HintLabelStyle}"
                                           LineBreakMode="TailTruncation" />
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Border>
                </VerticalStackLayout>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
